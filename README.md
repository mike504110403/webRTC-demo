# WebRTC ç›´æ’­ç³»çµ±ï¼ˆP2SFU2P æ¶æ§‹ï¼‰

> åŸºæ–¼ Pion WebRTC çš„ä½å»¶é²ç›´æ’­ç³»çµ±ï¼Œå¯¦ç¾ 1 å°å¤šå³æ™‚ä¸²æµ

## âœ¨ å·²å®ŒæˆåŠŸèƒ½

- âœ… **WebSocket Signaling Server**ï¼šSDP/ICE äº¤æ›
- âœ… **å…§å»º Pion WebRTC SFU**ï¼š1 å°å¤šåª’é«”è½‰ç™¼
- âœ… **ä¸»æ’­ç«¯**ï¼šæ¨æµåˆ° SFU
- âœ… **è§€çœ¾ç«¯**ï¼šå¾ SFU æ¥æ”¶ä¸²æµ
- âœ… **å±€åŸŸç¶²æ”¯æ´**ï¼šå¤šè¨­å‚™åŒ WiFi è¨ªå•
- âœ… **è‡ªå‹•ä¸»æ©Ÿæª¢æ¸¬**ï¼šç„¡éœ€æ‰‹å‹•é…ç½® IP

## ğŸ—ï¸ æŠ€è¡“æ¶æ§‹

### æŠ€è¡“æ£§

| å±¤ç´š | æŠ€è¡“ | èªªæ˜ |
|------|------|------|
| **å‰ç«¯** | Vue 3 + TypeScript | éŸ¿æ‡‰å¼ UIï¼Œé¡å‹å®‰å…¨ |
| **å¾Œç«¯** | Go + Pion WebRTC | é«˜æ€§èƒ½ï¼ŒåŸç”Ÿ WebRTC æ”¯æ´ |
| **é€šè¨Š** | WebSocket | ä½å»¶é²é›™å‘é€šè¨Šï¼ˆSignalingï¼‰ |
| **åª’é«”** | SRTP over WebRTC | åŠ å¯†å³æ™‚ä¸²æµï¼ˆDTLS æ¡æ‰‹ï¼‰ |

### æ ¸å¿ƒæ¦‚å¿µ

- **P2SFU2P**ï¼šä¸»æ’­ â†’ SFU â†’ å¤šå€‹è§€çœ¾
- **SDP äº¤æ›**ï¼šé€é WebSocket äº¤æ›åª’é«”èƒ½åŠ›
- **ICE ç©¿é€**ï¼šè‡ªå‹• NAT ç©¿é€
- **DTLS æ¡æ‰‹**ï¼šå»ºç«‹åŠ å¯†é€šé“
- **SRTP å‚³è¼¸**ï¼šåŠ å¯†éŸ³è¦–è¨Šå°åŒ…

## ğŸ¯ æŠ€è¡“æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸»æ’­ç«¯   â”‚         â”‚ Signalingâ”‚         â”‚  è§€çœ¾ç«¯   â”‚
â”‚          â”‚         â”‚  + SFU   â”‚         â”‚          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                    â”‚                    â”‚
     â”‚ 1. WebSocket é€£æ¥  â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
     â”‚                    â”‚                    â”‚
     â”‚ 2. Offer SDP       â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
     â”‚                    â”‚                    â”‚
     â”‚ 3. Answer SDP      â”‚                    â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                    â”‚                    â”‚
     â”‚ 4. ICE Candidates  â”‚                    â”‚
     â”‚<â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•>â”‚                    â”‚
     â”‚                    â”‚                    â”‚
     â”‚ 5. DTLS æ¡æ‰‹       â”‚                    â”‚
     â”‚<â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•>â”‚                    â”‚
     â”‚    âœ… é€£ç·šå»ºç«‹      â”‚                    â”‚
     â”‚                    â”‚                    â”‚
     â”‚ 6. æ¨é€ SRTP       â”‚                    â”‚
     â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•>â”‚                    â”‚
     â”‚                    â”‚                    â”‚
     â”‚                    â”‚  7. WebSocket é€£æ¥ â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    â”‚                    â”‚
     â”‚                    â”‚  8. Offer SDP      â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    â”‚                    â”‚
     â”‚                    â”‚  9. Answer SDP     â”‚
     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                    â”‚                    â”‚
     â”‚                    â”‚ 10. ICE Candidates â”‚
     â”‚                    â”‚<â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•>â”‚
     â”‚                    â”‚                    â”‚
     â”‚                    â”‚ 11. DTLS æ¡æ‰‹      â”‚
     â”‚                    â”‚<â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•>â”‚
     â”‚                    â”‚   âœ… é€£ç·šå»ºç«‹       â”‚
     â”‚                    â”‚                    â”‚
     â”‚                    â”‚ 12. è½‰ç™¼ SRTP      â”‚
     â”‚                    â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•>â”‚
     â”‚                    â”‚                    â”‚ â–¶ï¸ æ’­æ”¾
```

## ğŸ“‚ å°ˆæ¡ˆçµæ§‹

```
webRTC-demo/
â”œâ”€â”€ backend/                     # Go å¾Œç«¯
â”‚   â”œâ”€â”€ main.go                  # å…¥å£ï¼šHTTP + WebSocket + SFU
â”‚   â”œâ”€â”€ go.mod                   # ä¾è³´ç®¡ç†
â”‚   â””â”€â”€ internal/
â”‚       â”œâ”€â”€ signaling/           # WebSocket Signaling Server
â”‚       â”‚   â”œâ”€â”€ hub.go           # æˆ¿é–“ç®¡ç† + è¨Šæ¯å»£æ’­
â”‚       â”‚   â”œâ”€â”€ client.go        # WebSocket å®¢æˆ¶ç«¯è™•ç†
â”‚       â”‚   â”œâ”€â”€ handler.go       # HTTP â†’ WebSocket å‡ç´š
â”‚       â”‚   â””â”€â”€ types.go         # è¨Šæ¯çµæ§‹å®šç¾©
â”‚       â””â”€â”€ sfu/                 # å…§å»º Pion WebRTC SFU
â”‚           â””â”€â”€ sfu.go           # åª’é«”è½‰ç™¼é‚è¼¯
â”‚
â”œâ”€â”€ frontend/                    # Vue 3 å‰ç«¯
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ signaling.ts    # WebSocket å°è£
â”‚   â”‚   â”‚   â””â”€â”€ webrtc.ts       # RTCPeerConnection å°è£
â”‚   â”‚   â””â”€â”€ views/
â”‚   â”‚       â”œâ”€â”€ Broadcaster.vue # ä¸»æ’­ä»‹é¢
â”‚   â”‚       â””â”€â”€ Viewer.vue      # è§€çœ¾ä»‹é¢
â”‚   â””â”€â”€ vite.config.ts           # Vite é…ç½®ï¼ˆhost: 0.0.0.0ï¼‰
â”‚
â”œâ”€â”€ start.sh                     # å•Ÿå‹•è…³æœ¬ï¼ˆmacOS/Linuxï¼‰
â”œâ”€â”€ stop.sh                      # åœæ­¢è…³æœ¬
â””â”€â”€ docker-compose.yml           # Docker ç·¨æ’ï¼ˆé ç•™ï¼‰
```

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1ï¸âƒ£ å®‰è£ä¾è³´ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰

```bash
# å®‰è£å‰ç«¯ä¾è³´
cd frontend && npm install && cd ..

# å®‰è£å¾Œç«¯ä¾è³´
cd backend && go mod download && cd ..
```

### 2ï¸âƒ£ å•Ÿå‹•æœå‹™

```bash
# ä¸€éµå•Ÿå‹•ï¼ˆæ¨è–¦ï¼‰
./start.sh

# æˆ–æ‰‹å‹•å•Ÿå‹•
# çµ‚ç«¯ 1ï¼šå•Ÿå‹•å¾Œç«¯
cd backend && go run main.go

# çµ‚ç«¯ 2ï¼šå•Ÿå‹•å‰ç«¯
cd frontend && npm run dev
```

### 3ï¸âƒ£ è¨ªå•æ‡‰ç”¨

#### æœ¬æ©Ÿè¨ªå•

```
ä¸»æ’­ç«¯: http://localhost:5173/broadcaster
è§€çœ¾ç«¯: http://localhost:5173/viewer
å¾Œç«¯ API: http://localhost:8080/health
```

#### å±€åŸŸç¶²è¨ªå•ï¼ˆåŒä¸€ WiFiï¼‰

å‰ç«¯å•Ÿå‹•å¾Œæœƒé¡¯ç¤ºå±€åŸŸç¶² IPï¼š

```
VITE v5.x.x  ready in xxx ms

  âœ  Local:   http://localhost:5173/
  âœ  Network: http://192.168.1.181:5173/  â† ç”¨é€™å€‹ IP
```

**å…¶ä»–è¨­å‚™è¨ªå•**ï¼ˆæ‰‹æ©Ÿ/å¹³æ¿ï¼‰ï¼š

```
ä¸»æ’­ç«¯: http://192.168.1.181:5173/broadcaster
è§€çœ¾ç«¯: http://192.168.1.181:5173/viewer
```

### 4ï¸âƒ£ åœæ­¢æœå‹™

```bash
./stop.sh

# æˆ–æŒ‰ Ctrl+C åœæ­¢çµ‚ç«¯é€²ç¨‹
```

## ğŸ® ä½¿ç”¨èªªæ˜

### ä¸»æ’­ç«¯æ“ä½œ

1. è¨ªå•ä¸»æ’­é é¢
2. é»æ“Šã€Œé–‹å§‹ç›´æ’­ã€
3. æˆæ¬Šç€è¦½å™¨ä½¿ç”¨æ”åƒé ­/éº¥å…‹é¢¨
4. âœ… é–‹å§‹æ¨æµ

### è§€çœ¾ç«¯æ“ä½œ

1. è¨ªå•è§€çœ¾é é¢
2. é»æ“Šã€ŒåŠ å…¥ç›´æ’­ã€
3. âœ… è§€çœ‹ç›´æ’­

### æ¸¬è©¦å ´æ™¯

- **å–®æ©Ÿæ¸¬è©¦**ï¼šåŒä¸€å°é›»è…¦é–‹å…©å€‹ç€è¦½å™¨åˆ†é 
- **å¤šè¨­å‚™æ¸¬è©¦**ï¼šé›»è…¦ä¸»æ’­ + æ‰‹æ©Ÿè§€çœ¾
- **å¤šäººè§€çœ‹**ï¼š1 å€‹ä¸»æ’­ + N å€‹è§€çœ¾ï¼ˆåŒæ™‚è§€çœ‹ï¼‰

## ğŸ“Š æ€§èƒ½æŒ‡æ¨™

- **å»¶é²**ï¼š< 1 ç§’ï¼ˆP2SFU2P æ¶æ§‹ï¼‰
- **æ”¯æ´è§€çœ¾æ•¸**ï¼šç†è«–ç„¡ä¸Šé™ï¼ˆSFU è½‰ç™¼ï¼‰
- **ç¶²è·¯å”è­°**ï¼šWebRTC (SRTP)
- **åŠ å¯†**ï¼šDTLS 1.2

## ğŸ”§ é–‹ç™¼èªªæ˜

### å¾Œç«¯

```bash
cd backend

# åŸ·è¡Œ
go run main.go

# ç·¨è­¯
go build -o server main.go

# æ¸¬è©¦
curl http://localhost:8080/health
```

### å‰ç«¯

```bash
cd frontend

# é–‹ç™¼æ¨¡å¼
npm run dev

# ç·¨è­¯
npm run build

# é è¦½
npm run preview
```

## ğŸŒ ç¶²è·¯é…ç½®

### é˜²ç«ç‰†è¨­ç½®

å¦‚æœå±€åŸŸç¶²ç„¡æ³•è¨ªå•ï¼Œæª¢æŸ¥é˜²ç«ç‰†ï¼š

```bash
# macOSï¼šç³»çµ±åå¥½è¨­å®š â†’ å®‰å…¨æ€§èˆ‡éš±ç§ â†’ é˜²ç«ç‰†
# å…è¨± Go å’Œ Node.js æ¥å—é€£ç·š

# æˆ–è‡¨æ™‚é—œé–‰é˜²ç«ç‰†æ¸¬è©¦
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate off
```

### æŸ¥çœ‹æœ¬æ©Ÿ IP

```bash
# macOS
ifconfig | grep "inet " | grep -v 127.0.0.1

# æˆ–
ipconfig getifaddr en0
```

## ğŸ“ é—œéµæŠ€è¡“ç´°ç¯€

### WebSocket è¨Šæ¯æ ¼å¼

```typescript
{
  type: 'offer' | 'answer' | 'ice_candidate',
  payload: {
    sdp?: string,           // SDP å­—ä¸²
    candidate?: string,     // ICE å€™é¸
    userID: string,
    roomID: string
  }
}
```

### WebRTC é€£ç·šç‹€æ…‹

```
connecting â†’ connected â†’ disconnected/failed
```

### SFU è½‰ç™¼é‚è¼¯

```
ä¸»æ’­æ¨é€ Track â†’ SFU ç·©å­˜ â†’ è§€çœ¾è¨‚é–± â†’ SFU è½‰ç™¼
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### è§€çœ¾çœ‹ä¸åˆ°ç•«é¢

1. **æª¢æŸ¥å¾Œç«¯ log**ï¼šæ˜¯å¦æœ‰ `SetRemoteDescription` éŒ¯èª¤
2. **æª¢æŸ¥å‰ç«¯ Console**ï¼šPeerConnection ç‹€æ…‹
3. **é‡æ–°æ•´ç†é é¢**ï¼šæ¸…é™¤èˆŠçš„ WebRTC é€£ç·š
4. **é‡å•Ÿæœå‹™**ï¼š`./stop.sh` â†’ `./start.sh`

### å±€åŸŸç¶²ç„¡æ³•è¨ªå•

1. **ç¢ºèªåŒä¸€ WiFi**ï¼šæ‰€æœ‰è¨­å‚™é€£æ¥åŒä¸€å€‹ç¶²è·¯
2. **æª¢æŸ¥ IP åœ°å€**ï¼š`npm run dev` é¡¯ç¤ºçš„ Network IP
3. **é˜²ç«ç‰†è¨­ç½®**ï¼šå…è¨± 8080 å’Œ 5173 åŸ 
4. **ä½¿ç”¨ Chrome**ï¼šç§»å‹•è¨­å‚™ç”¨ Chrome ç€è¦½å™¨

### WebSocket é€£ç·šå¤±æ•—

1. **å¾Œç«¯æ˜¯å¦å•Ÿå‹•**ï¼š`curl http://localhost:8080/health`
2. **åŸ æ˜¯å¦è¢«ä½”ç”¨**ï¼š`lsof -i :8080`
3. **æª¢æŸ¥ CORS**ï¼šå·²è¨­ç½® `AllowedOrigins: ["*"]`

## ğŸ¯ MVP é©—æ”¶æ¨™æº–

- âœ… ä¸»æ’­èƒ½æ¨æµ
- âœ… å¤šå€‹è§€çœ¾åŒæ™‚è§€çœ‹
- âœ… å»¶é² < 1 ç§’
- âœ… å±€åŸŸç¶²è¨ªå•
- â³ æ–·ç·šè‡ªå‹•é‡é€£ï¼ˆå¾…å„ªåŒ–ï¼‰
- â³ æ€§èƒ½ç›£æ§ï¼ˆå¾…å¯¦ç¾ï¼‰

## ğŸš€ æœªä¾†æ“´å±•

### ä¸‹ä¸€æ­¥åŠŸèƒ½

- ğŸ”„ **æ–·ç·šé‡é€£**ï¼šè‡ªå‹•æ¢å¾© WebSocket å’Œ PeerConnection
- ğŸ **äº’å‹•åŠŸèƒ½**ï¼šé€ç¦®ã€é»è´Šï¼ˆWebSocket äº‹ä»¶ï¼‰
- ğŸ¤ **é€£éº¥åŠŸèƒ½**ï¼šè§€çœ¾å‡ç´šç‚ºå…±åŒä¸»æ’­ï¼ˆå¤š Trackï¼‰
- ğŸ“Š **ç›£æ§é¢æ¿**ï¼šbitrateã€RTTã€packet loss
- ğŸ” **èº«ä»½é©—è­‰**ï¼šJWT Token é©—è­‰
- ğŸ’¾ **æˆ¿é–“æŒä¹…åŒ–**ï¼šRedis å­˜å„²æˆ¿é–“ç‹€æ…‹

### æ¶æ§‹æ¼”é€²

```
MVPï¼ˆç•¶å‰ï¼‰        â†’ ç”Ÿç”¢ç’°å¢ƒ
â”œâ”€ å–® SFU ç¯€é»     â†’ å¤š SFU ç¯€é» + Load Balancer
â”œâ”€ ç¡¬ç·¨ç¢¼é…ç½®      â†’ ç’°å¢ƒè®Šæ•¸ + é…ç½®ä¸­å¿ƒ
â”œâ”€ HTTP           â†’ HTTPS (TLS è­‰æ›¸)
â””â”€ æœ¬åœ°éƒ¨ç½²        â†’ Kubernetes + Docker
```

## ğŸ“š åƒè€ƒè³‡æº

- [Pion WebRTC](https://github.com/pion/webrtc)
- [WebRTC API (MDN)](https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API)
- [Ion SFU](https://github.com/pion/ion-sfu)

---

**ç‰ˆæœ¬**ï¼šMVP v1.0  
**æœ€å¾Œæ›´æ–°**ï¼š2025-11-05  
**é–‹ç™¼ç‹€æ…‹**ï¼šâœ… æ ¸å¿ƒåŠŸèƒ½å®Œæˆï¼Œå¯å±•ç¤ºå’Œæ¸¬è©¦
